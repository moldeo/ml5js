<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Getting Started with ml5.js</title>
    <!-- p5 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.8.0/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.8.0/addons/p5.dom.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.8.0/addons/p5.sound.min.js"></script>
    <!-- ml5 -->
    <script src="https://unpkg.com/ml5@0.3.1/dist/ml5.min.js"></script>
    <!--<script src="sketch.js"></script>-->
  </head>

  <body>
    <script>
      // Your code will go here
      // open up your console - if everything loaded properly you should see 0.3.1
      console.log('ml5 version:', ml5.version);
      let mobilenet;
      let mobilenetExt;
      let model2load = "model.json";
      let pinguino;
      let width = 640;
      let height = 480;
      let label = "";
      let classifier;
      let trainButton;
      let labelButton;
      let inputClass;

      let slider;
      let regression;
      let trainregressionButton;
      let regreButton;

      let saveButton;
      let loadButton;

      function modelReady2Load() {
          console.log("Model ready 2 load:", model2load);
          classifier.load(model2load, customModelReady);
      }

      function customModelReady() {
          console.log("Custom model ready:",model2load);
          label = "ok"
      }

      function whileTraining(loss) {
          if (loss==null) {
              console.log("Training complete");
              classifier.classify(gotResultsExt)
          } else {
                console.log("Training... loss:",loss);
          }

      }

      function whileTrainingReg(loss) {
          if (loss==null) {
              console.log("Training Regression complete");
              regression.predict(gotResultsReg)
          } else {
                console.log("Training regression... loss:",loss);
          }

      }

      function modelReady() {
          console.log("Model ready!!");
          //mobilenet.predict(pinguino,gotResults)
          mobilenet.predict( gotResults)
      }

      function modelExtReady() {
          console.log("ModelExtractor ready!!");
      }

      function imageReady() {
          console.log("image ready!")
          image( pinguino, 0, 0, width, height)
      }

      function videoReady() {
          console.log("video ready!")
          //image( pinguino, 0, 0, width, height)
      }

      function gotResults(error, results ) {
        if (error) {
            console.error(error);
        } else {
            //console.log(results);
            label = results[0].label + ' '+int(results[0].confidence*100)+'%';
            mobilenet.predict( gotResults)
        }
      }

      function gotResultsExt(error, results ) {
        if (error) {
            console.error(error);
        } else {
            //console.log(results);
            label = results[0].label + ' '+int(results[0].confidence*100)+'%';
            classifier.classify( gotResultsExt)
        }
      }

      function gotResultsReg(error, results ) {
        if (error) {
            console.error(error);
        } else {
            //console.log(results);
            label = int(results.value*100);
            regression.predict( gotResultsReg)
        }
      }


      function setup(){
        createCanvas(width, height);
        video = createCapture(VIDEO);
        video.hide()
        //pinguino = createImg('pinguino.jpg', imageReady)
        //pinguino.hide()
        background(0)
        //mobilenet = ml5.imageClassifier("MobileNet", video, modelReady);
        mobilenetExt = ml5.featureExtractor("MobileNet", modelExtReady);
        //classifier = mobilenetExt.classification(video, videoReady);
        regression = mobilenetExt.regression(video, videoReady);
        labelButton = createButton("add label");
        inputClass = createInput();
        labelButton.mousePressed( function() {
            let mylabel = inputClass.elt.value;
            console.log(mylabel);
            if (mylabel.length>0) {
                res = classifier.addImage(mylabel);
                console.log("added label:",mylabel,res)
            }
        });
        trainButton = createButton("train");
        trainButton.mousePressed(function(){
            classifier.train(whileTraining);
        });


        slider = createSlider(0,1,0.5,0.01);
        slider.input(function() {
            console.log(slider.value());
        });

        regreButton = createButton("add val");
        regreButton.mousePressed(function(){
            regression.addImage(slider.value());
        })


        trainregressionButton = createButton("train");
        trainregressionButton.mousePressed(function(){
            regression.train(whileTrainingReg);
        });

        saveButton = createButton("save");
        saveButton.mousePressed(function(){
            console.log(regression.save());
        });

        loadButton = createButton("load");
        loadButton.mousePressed(function(){
            //regression.save();
            label = "model loading..."
            mobilenet = ml5.featureExtractor("MobileNet", modelReady2Load );
            classifier = mobilenet.classification( video, videoReady );
        });
      }

      function draw(){
          background(0);

          image(video,0,0,width,height-30);

          fill(255);
          textSize(25);
          text(label,10,height-10);

        //background(0);
        //image( pinguino, 0, 0, width, height)
      }
    </script>
  </body>
</html>
